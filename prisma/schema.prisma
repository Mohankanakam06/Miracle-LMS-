generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id                  String              @id @db.Uuid
  email               String?
  fullName            String?             @map("full_name")
  role                String              @default("student")
  avatarUrl           String?             @map("avatar_url")
  phone               String?
  department          String?
  semester            String?
  section             String?
  academicYear        String?             @default("2025-2026") @map("academic_year")
  regulation          String?
  rollNumber          String?             @map("roll_number")
  subject             String?
  isActive            Boolean             @default(true) @map("is_active")
  lastLoginAt         DateTime?           @map("last_login_at")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  currentSemester     Int?                @map("current_semester")
  year                Int?
  // Verification fields
  onboardingComplete  Boolean             @default(false) @map("onboarding_complete")
  verificationStatus  String              @default("pending") @map("verification_status") // pending, verified, failed
  claimedRollNumber   String?             @map("claimed_roll_number")
  masterListId        String?             @map("master_list_id") @db.Uuid
  verificationNote    String?             @map("verification_note")
  verifiedAt          DateTime?           @map("verified_at")
  // Notification preferences
  emailNotifications  Boolean             @default(true) @map("email_notifications")
  pushNotifications   Boolean             @default(true) @map("push_notifications")
  // Relations
  assignmentsCreated  Assignment[]        @relation("CreatedBy")
  attendanceMarked    Attendance[]        @relation("MarkedBy")
  attendanceRecords   Attendance[]
  chatLogs            ChatLog[]
  classesTeaching     Class[]             @relation("Teacher")
  enrollments         Enrollment[]
  escalatedQueries    EscalatedQuery[]
  eventRegistrations  EventRegistration[]
  facultyFeedback     FacultyFeedback[]
  fees                Fee[]
  forumPosts          ForumPost[]
  libraryBorrowings   LibraryBorrowing[]
  lostFoundItems      LostFound[]
  materialsUploaded   Material[]          @relation("UploadedBy")
  notifications       Notification[]
  submissionsGraded   Submission[]        @relation("GradedBy")
  submissions         Submission[]
  masterListEntry     StudentMasterList?  @relation(fields: [masterListId], references: [id])

  @@index([email])
  @@index([role])
  @@index([department, semester, section])
  @@index([rollNumber])
  @@map("profiles")
}

model StudentMasterList {
  id           String    @id @default(uuid()) @db.Uuid
  rollNumber   String    @unique @map("roll_number")
  email        String    @unique
  fullName     String    @map("full_name")
  branch       String
  section      String
  year         Int
  regulation   String
  isClaimed    Boolean   @default(false) @map("is_claimed")
  claimedBy    String?   @map("claimed_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  claimedProfile Profile[]

  @@index([rollNumber])
  @@index([email])
  @@map("student_master_list")
}

model Course {
  id             String          @id @default(uuid()) @db.Uuid
  name           String
  code           String          @unique
  description    String?
  semester       Int
  department     String
  credits        Int
  regulation     String?
  units          Json?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  classes        Class[]
  previousPapers PreviousPaper[]

  @@map("courses")
}

model Class {
  id           String       @id @default(uuid()) @db.Uuid
  courseId     String       @map("course_id") @db.Uuid
  teacherId    String       @map("teacher_id") @db.Uuid
  section      String
  academicYear String       @map("academic_year")
  department   String?
  semester     String?
  room         String?
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  assignments  Assignment[]
  attendance   Attendance[]
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher      Profile      @relation("Teacher", fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments  Enrollment[]
  materials    Material[]
  timetable    Timetable[]

  @@index([teacherId])
  @@index([courseId])
  @@index([department, semester, section])
  @@index([department, semester, section, academicYear])
  @@map("classes")
}

model Enrollment {
  id        String   @id @default(uuid()) @db.Uuid
  studentId String   @map("student_id") @db.Uuid
  classId   String   @map("class_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   Profile  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("enrollments")
}

model Timetable {
  id        String   @id @default(uuid()) @db.Uuid
  classId   String   @map("class_id") @db.Uuid
  dayOfWeek String   @map("day_of_week")
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  room      String?
  createdAt DateTime @default(now()) @map("created_at")
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, dayOfWeek, startTime])
  @@index([classId, dayOfWeek])
  @@map("timetable")
}

model Assignment {
  id          String       @id @default(uuid()) @db.Uuid
  classId     String       @map("class_id") @db.Uuid
  title       String
  description String?
  maxMarks    Int          @map("max_marks")
  dueDate     DateTime     @map("due_date")
  createdBy   String       @map("created_by") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  class       Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  creator     Profile      @relation("CreatedBy", fields: [createdBy], references: [id])
  submissions Submission[]

  @@index([classId])
  @@index([createdBy])
  @@index([dueDate])
  @@index([classId, dueDate])
  @@map("assignments")
}

model Submission {
  id           String     @id @default(uuid()) @db.Uuid
  assignmentId String     @map("assignment_id") @db.Uuid
  studentId    String     @map("student_id") @db.Uuid
  fileUrl      String?    @map("file_url")
  notes        String?
  submittedAt  DateTime   @default(now()) @map("submitted_at")
  status       String     @default("submitted")
  marks        Int?
  feedback     String?
  gradedBy     String?    @map("graded_by") @db.Uuid
  gradedAt     DateTime?  @map("graded_at")
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  grader       Profile?   @relation("GradedBy", fields: [gradedBy], references: [id])
  student      Profile    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@map("submissions")
}

model Attendance {
  id        String   @id @default(uuid()) @db.Uuid
  studentId String   @map("student_id") @db.Uuid
  classId   String   @map("class_id") @db.Uuid
  date      DateTime
  status    String
  markedBy  String?  @map("marked_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  marker    Profile? @relation("MarkedBy", fields: [markedBy], references: [id])
  student   Profile  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, date])
  @@index([studentId])
  @@index([classId])
  @@index([date])
  @@index([classId, date])
  @@map("attendance")
}

model Material {
  id           String   @id @default(uuid()) @db.Uuid
  classId      String?  @map("class_id") @db.Uuid
  title        String
  description  String?
  type         String
  fileUrl      String?  @map("file_url")
  externalLink String?  @map("external_link")
  uploadedBy   String   @map("uploaded_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  class        Class?   @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploader     Profile  @relation("UploadedBy", fields: [uploadedBy], references: [id])

  @@index([classId])
  @@index([uploadedBy])
  @@index([type])
  @@map("materials")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  title     String
  message   String
  type      String   @default("info")
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      Profile? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([userId, read, createdAt])
  @@index([type])
  @@map("notifications")
}

model Fee {
  id            String    @id @default(uuid()) @db.Uuid
  studentId     String    @map("student_id") @db.Uuid
  description   String
  amount        Float
  dueDate       DateTime  @map("due_date")
  paidDate      DateTime? @map("paid_date")
  status        String    @default("pending")
  transactionId String?   @map("transaction_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  student       Profile   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@index([studentId, status])
  @@index([dueDate])
  @@map("fees")
}

model ExamSchedule {
  id           String   @id @default(uuid()) @db.Uuid
  courseCode   String   @map("course_code")
  examType     String   @map("exam_type")
  examDate     DateTime @map("exam_date")
  startTime    String   @map("start_time")
  endTime      String   @map("end_time")
  room         String?
  semester     Int
  department   String
  academicYear String   @map("academic_year")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("exam_schedule")
}

model AcademicCalendar {
  id          String   @id @default(uuid()) @db.Uuid
  title       String
  description String?
  eventDate   DateTime @map("event_date")
  eventType   String   @map("event_type")
  semester    Int?
  department  String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("academic_calendar")
}

model SyllabusProgress {
  id            String    @id @default(uuid()) @db.Uuid
  courseCode    String    @map("course_code")
  unit          Int
  topic         String
  completed     Boolean   @default(false)
  completedDate DateTime? @map("completed_date")
  semester      Int
  department    String
  section       String
  academicYear  String    @map("academic_year")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("syllabus_progress")
}

model PreviousPaper {
  id         String   @id @default(uuid()) @db.Uuid
  courseId   String   @map("course_id") @db.Uuid
  title      String
  year       Int
  examType   String   @map("exam_type")
  fileUrl    String   @map("file_url")
  regulation String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("previous_papers")
}

model DiscussionForum {
  id          String      @id @default(uuid()) @db.Uuid
  title       String
  description String?
  category    String
  createdAt   DateTime    @default(now()) @map("created_at")
  posts       ForumPost[]

  @@map("discussion_forums")
}

model ForumPost {
  id        String          @id @default(uuid()) @db.Uuid
  forumId   String          @map("forum_id") @db.Uuid
  authorId  String          @map("author_id") @db.Uuid
  content   String
  parentId  String?         @map("parent_id") @db.Uuid
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  author    Profile         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  forum     DiscussionForum @relation(fields: [forumId], references: [id], onDelete: Cascade)
  parent    ForumPost?      @relation("PostReplies", fields: [parentId], references: [id])
  replies   ForumPost[]     @relation("PostReplies")

  @@map("forum_posts")
}

model Announcement {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  content     String
  priority    String    @default("normal")
  targetRole  String?   @map("target_role")
  department  String?
  semester    Int?
  section     String?
  publishedAt DateTime  @default(now()) @map("published_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("announcements")
}

model FacultyFeedback {
  id           String   @id @default(uuid()) @db.Uuid
  facultyId    String   @map("faculty_id") @db.Uuid
  studentId    String   @map("student_id") @db.Uuid
  semester     Int
  academicYear String   @map("academic_year")
  ratings      Json
  comments     String?
  anonymous    Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  faculty      Profile  @relation(fields: [facultyId], references: [id], onDelete: Cascade)

  @@map("faculty_feedback")
}

model LibraryBook {
  id          String             @id @default(uuid()) @db.Uuid
  title       String
  author      String
  isbn        String?            @unique
  publisher   String?
  category    String
  totalCopies Int                @map("total_copies")
  available   Int
  location    String?
  createdAt   DateTime           @default(now()) @map("created_at")
  borrowings  LibraryBorrowing[]

  @@map("library_books")
}

model LibraryBorrowing {
  id         String      @id @default(uuid()) @db.Uuid
  bookId     String      @map("book_id") @db.Uuid
  userId     String      @map("user_id") @db.Uuid
  borrowedAt DateTime    @default(now()) @map("borrowed_at")
  dueDate    DateTime    @map("due_date")
  returnedAt DateTime?   @map("returned_at")
  status     String      @default("borrowed")
  fine       Float?
  book       LibraryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user       Profile     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("library_borrowings")
}

model LostFound {
  id          String    @id @default(uuid()) @db.Uuid
  itemName    String    @map("item_name")
  description String?
  category    String
  status      String    @default("lost")
  location    String?
  reportedBy  String    @map("reported_by") @db.Uuid
  reportedAt  DateTime  @default(now()) @map("reported_at")
  claimedAt   DateTime? @map("claimed_at")
  imageUrl    String?   @map("image_url")
  reporter    Profile   @relation(fields: [reportedBy], references: [id], onDelete: Cascade)

  @@map("lost_found")
}

model Event {
  id                   String              @id @default(uuid()) @db.Uuid
  title                String
  description          String?
  eventType            String              @map("event_type")
  startDate            DateTime            @map("start_date")
  endDate              DateTime            @map("end_date")
  venue                String?
  organizer            String?
  maxParticipants      Int?                @map("max_participants")
  registrationDeadline DateTime?           @map("registration_deadline")
  imageUrl             String?             @map("image_url")
  createdAt            DateTime            @default(now()) @map("created_at")
  registrations        EventRegistration[]

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid()) @db.Uuid
  eventId      String   @map("event_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  registeredAt DateTime @default(now()) @map("registered_at")
  status       String   @default("registered")
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_registrations")
}

model ChatLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  message    String
  response   String
  intent     String?
  confidence Float?
  createdAt  DateTime @default(now()) @map("created_at")
  user       Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_logs")
}

model KnowledgeBase {
  id        String   @id @default(uuid()) @db.Uuid
  question  String
  answer    String
  category  String
  keywords  String[]
  priority  Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("knowledge_base")
}

model EscalatedQuery {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  query      String
  category   String
  status     String    @default("pending")
  assignedTo String?   @map("assigned_to")
  resolution String?
  createdAt  DateTime  @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")
  user       Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("escalated_queries")
}
